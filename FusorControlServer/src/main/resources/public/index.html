<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>fusor control | sensors</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        html,
        body {
            font-size: 1.1em;
            width: 100%;
            background: linear-gradient(rgb(0,0,70), rgb(0, 0, 40));
            color: white;
        }

        .container {
            margin: 2em, 7em;
        }

        .button {
            height: 50px;
            width: 24.5%;
            border: none;
            border-radius: 8px;
            background-color: #99c2ff;
            color: white;
            font-size: 16px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="container">
        <center>
            <h1>Fusor Control</h1>
        </center>
        <!--<h2>Arduino Status: <span id="astatus"></span></h2>
            <h2>Variac Status: <span id="vstatus"></span></h2>
            <h2>TMP Status: <span id="pstatus"></span></h2>-->
        <hr>
        <h2>Initialization</h2>
        <button id="isWorking" class='button' onclick="isWorking()">Test Connection</button>
        <button id="inita" class='button'>Initiate Arduino Serial Comm</button>
        <button id="status" class='button' onclick="getStatus()">Get Status</button>
        <button class='button' style="background-color: lightcoral" onclick="kill()"><b>KILL SERVER</b></button>
        <hr>



        <h2>Control</h2>
        <h3>Variac Input Voltage: </h3>
        <input id="variacValue"><button onclick="variac()" id="variacButton">Set</button>
        <h3>Turbo-Molecular Pump Voltage: </h3>
        <input id="tmp"><button onclick="tmp()" id="tmpButton">Set</button>
        <!--<h3>Solenoid Valve: <button onclick="solenoid('on')">OPEN</button><button onclick="solenoid('off')" 
                style="color: lightcoral;">CLOSE</button> </h3> -->
        <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="customSwitch1"
                onchange="solenoid(this.checked ? 'on':'off')">
            <h3><label class="custom-control-label" for="customSwitch1">Solenoid Valve On</label></h3>
        </div>
        <hr>
        <h2>testing (for status reports only)</h2>
        <button onclick="initStatus()">start recieving status reports</button>
        <div style="color: lightcoral">
            <h2>Arduino Status: <span id="astatus" style="color: black;"> </span></h2>
            <h2>Variac Status: <span id="vstatus" style="color: black;"> </span></h2>
            <h2>TMP Status: <span id="pstatus" style="color: black;"> </span></h2>
        </div>
        <hr>
        <p id="error">returns: </p>
    </div>


    <script type="text/javascript">
        var endTest = false;

        document.getElementById("variacValue").addEventListener("keyup", function (event) {
            if (event.keyCode === 13) { //enter key: 13
                event.preventDefault();
                document.getElementById("variacButton").click();
            }
        });
        document.getElementById("tmp").addEventListener("keyup", function (event) {
            if (event.keyCode === 13) { //enter key: 13
                event.preventDefault();
                document.getElementById("tmpButton").click();
            }
        });

        //could be achieved with less latency if using WebSocket
        function initStatus() {
            console.log("recieving status...")
            setInterval(getStatus, 500); //per every 0.5 seconds
        }

        //new request & xmlRequest function (spark stuff)
        function request(obj) {
            return new Promise((resolve, reject) => {
                let xhr = new XMLHttpRequest();
                xhr.open(obj.method || "GET", obj.url);

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject(xhr.statusText);
                    }
                };
                xhr.onerror = () => reject(xhr.statusText);

                xhr.send(obj.body);
            });
        };

        function xmlRequest(verb, url) {
            var xhr = new XMLHttpRequest();
            xhr.open(verb || "GET", url, true);
            xhr.onload = () => {
                console.log(xhr.response);
            };
            xhr.onerror = () => {
                console.log("error: " + statusText);
            };
            xhr.send();
        }
        //gets status of TMP
        function getStatus() {
            request({ url: "/getstatus", method: "GET" })
                .then(data => {
                    let status = JSON.parse(data);
                    console.log(status);
                    for (var i = 0; i < status.length; i++) {
                        document.getElementById("astatus").innerHTML = status[i].arconValue;
                        document.getElementById("pstatus").innerHTML = "tmpv = " + status[i].tmpv + "; tmps = " + status[i].tmps;
                        document.getElementById("vstatus").innerHTML = "waiting for variac values...";
                    }
                })
                .catch(error => {
                    console.log("error: " + error);
                });
        }

        //this kills the server (needs testing)
        function kill() {
            request({ url: "/kill", method: "GET" })
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                    console.log("error: " + error);
                });
        }

        //control variac
        function variac() {
            var variacValue = document.getElementById("variacValue");
            try {
                request({ url: "/variac?value=" + variacValue.value, method: "GET" })
                    .then(data => {
                        console.log(data);
                    })
                    .catch(error => {
                        console.log("error: " + error);
                    });
            } catch (error) {
                console.log("Error: " + error)
            }
            variacValue.Value = "";
        }

        //control tmp
        function tmp() {
            var tmpValue = document.getElementById("tmp");
            try {
                request({ url: "/tmp?value=" + tmpValue.value, method: "GET" })
                    .then(data => {
                        console.log(data);
                    })
                    .catch(error => {
                        console.log("error: " + error);
                    });
            } catch (error) {
                console.log("Error: " + error)
            }
            tmpValue.Value = "";
        }

        //control the solenoid
        function solenoid(isOn) {
            let solenoidIsOn = isOn == "on";
            request({ url: "/solenoid?isOn=" + solenoidIsOn, method: "GET" })
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                    console.log("error: " + error);
                });
        }
    </script>
</body>

</html>